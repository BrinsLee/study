### 卡顿本质是错过vsync绘制时机

60fps 意味着16.66ms内完成绘制，如果有一些复杂的绘制无法在16.66ms内完成就会发生丢帧现象，在32ms内看到的都是同一帧

### 原因1：界面绘制

绘制任务过重，绘制一帧内容耗时过长，导致卡顿

### 原因2：数据处理

1. 数据处理在UI线程：耗时的数据处理放在UI线程会导致UI线程等待时间过长，导致卡顿
2. 数据处理占用CPU高：虽然我们会把耗时的数据处理放到异步线程，但如果数据处理开了多个线程，而且计算量巨大的话，依然会给 CPU 造成很大的负担，从而导致主线程拿不到时间片。
3. 内存增加导致GC频繁：GC 的时候有时会 “Stop World”，也就是所有的计算都停止，待 GC 完成后再进行运算，如果频繁的 “Stop World” 就会非常影响性能，从而导致卡顿。

### 优化

**1、布局优化**

1. 减少代码层级，多使用include，merge，viewStub标签
2. 减少同一层级控件数量
3. 删除无用属性
4. 如果层级相同 LinearLayout 要优于 RelativeLayout，因为 RelativeLayout 会对子 View 做2次测量。
5. 如果 LinearLayout 有 weight 属性，也需要2次测量，但由于没有依赖关系，仍然比 RelativeLayout 的效率高。
6. ViewStub 提高显示速度，如果某个布局中多个元素可能只会显示一部分，而另一部分不会显示，应该选用 ViewStub，它可以实现延迟加载布局。
7. 尽量少用 wrap_content，它会增加布局的计算成本，如果已知宽度为固定值时，尽量写固定值。

**2、减少主线程耗时占用**

在实际的开发过程中，总结起来主线程主要做以下几个方面的工作：

- UI生命周期
- 系统事件处理
- 消息处理
- 界面布局、绘制、刷新

**3、避免过度绘制**

过度绘制（Overdraw）指的是屏幕中某一像素在同一帧的时间内会被绘制多次，在多层级重叠的UI架构中，如带背景的 TextView）中，如果不可见的 UI 也在做绘制的操作，就会导致某些像素区域被绘制了多次，从而浪费多余的 CPU 以及 GPU 资源。

#### 原因

- XML 布局：控件有重叠且都有设置背景
- View 自绘：View.OnDraw 里面同一个区域被绘制多次

#### 解决方法：

##### 方法1：减少重叠部分背景设置

XML 布局的时候尽可能减少为重叠部分都设置背影色（完全杜绝是不太可能的，我们有针对性的注意减少就行）

方法2：自定义 View onDraw 方法
自定义View 中 onDraw 注意同一个区域绘制次数。

方法3：去掉 window 的默认背景
使用 Android 自带的主题时，window 会被默认添加背景色，当我们布局时再设置 background 属性时，window 默认的背景色就没什么用了，而且设置2次背景色也会导致 Overdraw，从而带来性能损耗。

有2个方法可以去掉 window 自带的背影色：

在 Activity onCreate() 中 setContentView() 之后调用 getWindow().setBackgroundDrawable(null);
在 theme 中添加 android:windowbackground=“null”；
方法4：ClipRect & QuickReject
虽然自定义 View 减少了 Layout 的层级，但在实际绘制时也是会过度绘制的。原因是有些过于复杂的自定义 View（通常重写了onDraw方法），Android 系统无法检测在 onDraw 中具体会执行什么操作，无法监控并自动优化，也就无法避免 Overdraw 了。

解决方法：

在自定义 View 中可以通过 canvas.clipRect（）来帮助系统识别那些可见的区域。这个方法可以指定一块矩形区域，只有在这个区域内才会被绘制，其他的区域会被忽视。它可以节约CPU和GPU资源。
可以使用 canvas.quickreject（）来判断是否没和某个矩形相交，从而跳过那些非矩形区域内的绘制操作。

### 检测

### 卡顿检测：Profile GPU Rendering

打开方式：

1. 系统设置
2. 开发者选项
3. Profile GPU Rendering

- 蓝色：代表测量绘制的时间，它对应视图的 onDraw 函数，如果该颜色很高，表示 onDraw 函数处理的事情太多。
- 红色：代表执行2D渲染 Display List 的时间。如果该颜色较高，可能是重新提交了视图导致。
- 橙色：CPU 告诉 GPU 渲染一帧的地方，这是一个阻塞调用，因为 CPU 会一直等待 GPU 发出命令的回复，如果很高，表示 GPU 太繁忙。
- 紫色：表示将资源转移到渲染线程的时间，只有4.0及以上的版本才会提供。

### 过度绘制检测：Show GPU Overdraw

打开方法：

1. 系统设置
2. 开发者选项
3. 显示 GPU 过度重绘

在设置时，如果有App已经打开，需要终止App进程，重新启动。

1. 常规影响

   绘制层级、过度绘制

2. 内存影响

   STW现象导致，时间或者自定义View绘制时，在频繁调用的函数(如 onDraw)中创建对象

3. 线程影响

   主线程中执行耗时操作