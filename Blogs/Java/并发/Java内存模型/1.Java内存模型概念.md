Java内存模型概念
---

### 区分JVM内存结构与Java内存模型

- JVM内存结构和Java虚拟机的运行时区域有关
- Java内存模型和Java的并发编程有关

### JVM内存结构

#### Java虚拟机规范

虚拟机在执行Java程序的过程中会把所管理的内存划分为不同的数据区域.JVM运行时内存区域结构可分为以下6个区(Java SE 8),以下是Java虚拟机规范,不同的虚拟机实现各有不同,一般会遵守规范.

- 堆区(Heap): 堆是存储类实例和数组的,通常是内存中最大的一块.(数组也是对象)
- 虚拟机栈(Java Virtual Machine Stacks): 它保存局部变量和部分结果,并在方法调用和返回中起作用
- 方法区(Method Area): 它存储每个类的结构,例如运行时的常量池、字段和方法数据,以及方法和构造函数的代码,包括用于类初始化以及接口初始化的特殊方法.
- 本地方法栈(Native Method Stacks): 与虚拟机栈基本类似,区别在于虚拟机栈为虚拟机执行的Java方法服务,而本地方法栈则是为Native方法服务
- 程序计数器(The PC Register): 是最小的一块内存区域,它的作用通常是保存当前正在执行的JVM指令地址
- 运行时常量池(RunTime Constant Pool) : 是方法区的一部分,包含多种常量,范围从编译时已知的数字到必须在运行时解析的方法和字段引用.

#### 编译运行过程

- 编写`*.java`代码
- 编译(包含词法分析,语义分析等步骤)后,在刚才的`*.java`文件之外,会多处一个新的Java字节码文件(`*.class`)
- JVM会分析刚才生成的字节码文件,并根据平台等因素,把字节码文件转换为具体平台上的机器指令
- 机器指令则可以直接在CPU上运行,也就是最终的程序执行

### JVM内存模型 JMM(Java Memory Model)

JMM 是和多线程相关的一组规范,需要各个 JVM 的实现来遵守 JMM 规范，以便于开发者可以利用这些规范,更方便地开发多线程程序.这样一来,即便同一个程序在不同的虚拟机上运行.得到的程序结果也是一致的.

之前我们使用了各种同步工具和关键字，包括 volatile、synchronized、Lock 等，其实它们的原理都涉及 JMM.

JMM 里最重要 3 点内容,分别是：**重排序、原子性、内存可见性**